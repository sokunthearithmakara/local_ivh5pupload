{"version":3,"file":"main.min.js","sources":["../src/main.js"],"sourcesContent":["/* eslint-disable complexity */\n// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Main class for the H5P Upload plugin.\n *\n * @module     local_ivh5pupload/main\n * @copyright  2024 Sokunthearith Makara <sokunthearithmakara@gmail.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport $ from 'jquery';\nimport Base from 'mod_interactivevideo/type/base';\nimport {notifyFilterContentUpdated as notifyFilter} from 'core_filters/events';\nimport Notification from 'core/notification';\n\nexport default class H5pUpload extends Base {\n\n    /**\n     * Handles the rendering of content after an annotation is posted.\n     *\n     * This function adds a class to the message element, sets an interval to check for an iframe,\n     * and modifies the iframe's background and height properties. It also handles completion tracking.\n     *\n     * @param {Object} annotation - The annotation object containing details about the annotation.\n     * @param {Function} callback - The callback function to be executed if certain conditions are met.\n     * @returns {boolean|Function} - Returns true if the annotation does not require manual completion tracking,\n     *                               otherwise returns the callback function.\n     */\n    postContentRender(annotation, callback) {\n        let self = this;\n        let $message = $(`#message[data-id='${annotation.id}']`);\n        $message.addClass('hascontentbank overflow-hidden');\n        // Get customcss link from the annotation prop.\n        let prop = JSON.parse(annotation.prop);\n        let customcss = prop.customcss;\n        let checkIframe = () => {\n            const iframe = document.querySelector(`#message[data-id='${annotation.id}'] iframe`);\n            if (iframe) {\n                iframe.style.background = 'none';\n                let contentDocument = iframe.contentDocument;\n                let h5p = contentDocument.querySelector('.h5p-initialized');\n                if (h5p) {\n                    $(`#message[data-id='${annotation.id}']`).removeClass('overflow-hidden').find('.loader').remove();\n                    let html = contentDocument.querySelector('html');\n                    html.style.height = 'unset';\n                    // Get the first div element after html body.\n                    let firstdiv = contentDocument.querySelector('body > div');\n                    if (firstdiv) {\n                        firstdiv.style.margin = '0';\n                    }\n                    if (customcss && annotation.char2 == '1') {\n                        let iframeurl = iframe.src;\n                        let fileextension = iframeurl.split('.').pop();\n                        // Inject stylesheet url to iframe head.\n                        let link, node;\n                        if (fileextension == 'html') { // HTML iframe.\n                            link = contentDocument.createElement('link');\n                            node = contentDocument.head;\n                        } else { // H5P iframe.\n                            let h5piframe = contentDocument.querySelector(`#${h5p.id}`);\n                            let h5piframecontent = h5piframe.contentDocument;\n                            link = h5piframecontent.createElement('link');\n                            node = h5piframecontent.head;\n                        }\n                        // Get the html tag as node's parent and add dir=\"rtl\" to it.\n                        let dir = $('html').attr('dir');\n                        let setDir = JSON.parse(annotation.advanced).dir;\n                        if (setDir && setDir != '') {\n                            dir = setDir;\n                        } else if (setDir && setDir == '') {\n                            dir = $('html').attr('dir');\n                        } else {\n                            dir = '';\n                        }\n                        if (dir != '') {\n                            let htmltag = node.parentNode;\n                            if (htmltag) {\n                                htmltag.setAttribute('dir', dir);\n                            }\n                        }\n                        link.rel = 'stylesheet';\n                        link.type = 'text/css';\n                        link.href = customcss;\n                        node.appendChild(link);\n                    }\n                } else {\n                    requestAnimationFrame(checkIframe);\n                }\n            } else {\n                requestAnimationFrame(checkIframe);\n            }\n        };\n        requestAnimationFrame(checkIframe);\n        if (annotation.completiontracking !== 'view') {\n            let $completiontoggle = $message.find('#completiontoggle');\n            $message.find('#title .info').remove();\n            $completiontoggle.before(`<i class=\"bi bi-info-circle-fill iv-mr-2 info\" data${self.isBS5 ? '-bs' : ''}-toggle=\"tooltip\"\n            data${self.isBS5 ? '-bs' : ''}-container=\"#message\" data${self.isBS5 ? '-bs' : ''}-trigger=\"hover\"\n            title=\"${M.util.get_string(\"completionon\" + annotation.completiontracking, \"mod_interactivevideo\")}\"></i>`);\n            if (!annotation.completed) {\n                $message.find(`#title [data${self.isBS5 ? '-bs' : ''}-toggle=\"tooltip\"]`).tooltip('show');\n                setTimeout(function() {\n                    $message.find(`#title [data${self.isBS5 ? '-bs' : ''}-toggle=\"tooltip\"]`).tooltip('hide');\n                }, 2000);\n            }\n        }\n        if (annotation.hascompletion == 1 && annotation.completiontracking == 'manual'\n            && !annotation.completed && annotation.completiontracking != 'view') {\n            return callback;\n        }\n        return true;\n    }\n\n    /**\n     * Called when the edit form is loaded.\n     * @param {Object} form The form object\n     * @param {Event} event The event object\n     * @return {void}\n     */\n    onEditFormLoaded(form, event) {\n        let self = this;\n        self.timepicker({\n            required: true,\n        });\n\n        return {form, event};\n    }\n\n    /**\n     * Apply the content to the annotation\n     * @param {Object} annotation The annotation object\n     * @param {Object} existingstate The existing state of the annotation\n     * @returns {Promise<void>} - Returns a promise that resolves when the content is applied.\n     * @override\n     */\n    async applyContent(annotation, existingstate) {\n        let self = this;\n        let $message = $(`#message[data-id='${annotation.id}']`);\n        // Remove .modal-dialog-centered class to avoid flickering when H5P content resizes.\n        $message.removeClass('modal-dialog-centered');\n\n        let annoid = annotation.id;\n\n        const onPassFail = async(passed, time) => {\n            let label = passed ? 'continue' : 'rewatch';\n            $message.find('#content')\n                .append(`<button class=\"btn btn-${passed ? 'success' : 'danger'} mt-2 btn-rounded\"\n                        id=\"passfail\" data-timestamp=\"${time}\"><i class=\"fa fa-${passed ? 'play' : 'redo'} iv-mr-2\"></i>\n                    ${M.util.get_string(label, 'ivplugin_contentbank')}\n                    </button>`);\n            $message.find('iframe').addClass('no-pointer-events');\n        };\n\n        $(document).off('click', '#passfail').on('click', '#passfail', function(e) {\n            e.preventDefault();\n            let time = $(this).data('timestamp');\n            // Trigger close button.\n            $message.find('.interaction-dismiss').trigger('click');\n            self.player.seek(time);\n            self.player.play();\n            $(this).remove();\n        });\n\n        let saveState = 0;\n        let condition = null;\n        if (annotation.text1 != '' && annotation.text1 !== null) {\n            condition = JSON.parse(annotation.text1);\n        }\n\n        if (JSON.parse(annotation.advanced).savecurrentstate == 1) {\n            saveState = 1;\n        }\n\n        const afterLog = async(log) => {\n            const xAPICheck = (annotation) => {\n                const detectH5P = () => {\n                    let H5P;\n                    try { // Try to get the H5P object.\n                        H5P = document.querySelector(`#message[data-id='${annoid}'] iframe`).contentWindow.H5P;\n                    } catch (e) {\n                        H5P = null;\n                    }\n                    if (typeof H5P !== 'undefined' && H5P !== null) {\n                        if (H5P.externalDispatcher === undefined) {\n                            requestAnimationFrame(detectH5P);\n                            return;\n                        }\n                        if (document.querySelector(`#message[data-id='${annoid}'] iframe`)\n                            .contentWindow.H5PIntegration === undefined) {\n                            requestAnimationFrame(detectH5P);\n                            return;\n                        }\n\n                        if (self.isEditMode()) {\n                            $message.find(`#title .btns .xapi`).remove();\n                            $message.find(`#title .btns`)\n                                .prepend(`<div class=\"xapi alert-secondary px-2\n                             rounded-pill\">${M.util.get_string('xapicheck', 'ivplugin_contentbank')}</div>`);\n                        }\n\n                        window.H5PIntegration = document.querySelector(`#message[data-id='${annoid}'] iframe`)\n                            .contentWindow.H5PIntegration;\n                        window.H5PIntegration = window.H5PIntegration || {};\n                        window.H5PIntegration.saveFreq = 1;\n                        let content = window.H5PIntegration.contents;\n                        let id = Object.keys(content)[0];\n                        if (existingstate !== null && existingstate !== undefined) {\n                            log = existingstate;\n                        }\n                        window.H5PIntegration.contents[id].contentUserData = {};\n                        window.H5PIntegration.contents[id].contentUserData[0] = {};\n                        window.H5PIntegration.contents[id].contentUserData[0].state = log;\n                        window.H5P = H5P;\n                        if (annotation.completed) {\n                            return;\n                        }\n                        try {\n                            H5P.externalDispatcher.on('xAPI', async function(event) {\n                                let statement = event.data.statement;\n                                if ((statement.verb.id == 'http://adlnet.gov/expapi/verbs/completed'\n                                    || statement.verb.id == 'http://adlnet.gov/expapi/verbs/answered')\n                                    && statement.object.id.indexOf('subContentId') < 0\n                                    && !statement.context.contextActivities.parent) {\n                                    if (self.isEditMode()) {\n                                        $(`#message[data-id='${annotation.id}'] #title .btns .xapi`).remove();\n                                        $(`#message[data-id='${annotation.id}'] #title .btns`)\n                                            .prepend(`<div class=\"xapi alert-success d-inline px-2 rounded-pill\">\n                                                        <i class=\"fa fa-check iv-mr-2\"></i>\n                                                        ${M.util.get_string('xapieventdetected', 'ivplugin_contentbank')}\n                                                    </div>`);\n                                        const audio = new Audio(M.cfg.wwwroot + '/mod/interactivevideo/sounds/pop.mp3');\n                                        audio.play();\n                                        return;\n                                    }\n                                    let complete = false;\n                                    let textclass = '';\n                                    let result = statement.result;\n                                    if (annotation.completiontracking == 'completepass' && result && result.score.scaled >= 0.5) {\n                                        complete = true;\n                                    } else if (annotation.completiontracking == 'completefull'\n                                        && result && result.score.scaled == 1) {\n                                        complete = true;\n                                    } else if (annotation.completiontracking == 'complete') {\n                                        complete = true;\n                                    }\n                                    if (result.score.scaled < 0.5) {\n                                        textclass = 'fa fa-check text-danger';\n                                    } else if (result.score.scaled < 1) {\n                                        textclass = 'fa fa-check text-success';\n                                    } else {\n                                        textclass = 'bi bi-check2-all text-success';\n                                    }\n                                    if (complete && !annotation.completed) {\n                                        let details = {};\n                                        const completeTime = new Date();\n                                        let windowAnno = window.ANNOS.find(x => x.id == annotation.id);\n                                        details.xp = annotation.xp;\n                                        if (annotation.char1 == '1') { // Partial points.\n                                            details.xp = (result.score.scaled * annotation.xp).toFixed(2);\n                                        }\n                                        details.duration = windowAnno.duration + (completeTime.getTime() - windowAnno.newstarttime);\n                                        details.timecompleted = completeTime.getTime();\n                                        const completiontime = completeTime.toLocaleString();\n                                        let duration = self.formatTime(details.duration / 1000);\n                                        details.reportView = `<span data-toggle=\"tooltip\"\n                                         data-html=\"true\" data-title='<span\n                                          class=\"d-flex flex-column align-items-start\"><span><i class=\"bi bi-calendar iv-mr-2\"></i>\n                         ${completiontime}</span><span><i class=\"bi bi-stopwatch iv-mr-2\"></i>${duration}</span>\n                         <span><i class=\"bi bi-list-check iv-mr-2\"></i>\n                         ${result.score.raw}/${result.score.max}</span></span>'>\n                         <i class=\"${textclass}\"></i><br><span>${Number(details.xp)}</span></span>`;\n                                        details.details = saveState == 1 ?\n                                            window.H5PIntegration.contents[id].contentUserData[0].state : '';\n                                        // Must wait 1.5 seconds or so to let the saveState finish.\n                                        // Otherwise, the completion will be incomplete.\n                                        setTimeout(function() {\n                                            self.toggleCompletion(annoid, 'mark-done', 'automatic', details);\n                                        }, 1500);\n                                    }\n\n                                    if (condition !== null) {\n                                        if (result.score.scaled < 0.5) {\n                                            if (condition.gotoonfailed == 1 && condition.forceonfailed != 1) {\n                                                onPassFail(false, condition.timeonfailed);\n                                            } else if (condition.gotoonfailed == 1 && condition.forceonfailed == 1) {\n                                                setTimeout(function() {\n                                                    // Trigger close button.\n                                                    $message.find('.interaction-dismiss').trigger('click');\n                                                    self.player.seek(condition.timeonfailed);\n                                                    self.player.play();\n                                                }, 1000);\n                                            }\n                                            if (condition.showtextonfailed == 1 && condition.textonfailed.text != '') {\n                                                let textonfailed = await self.formatContent(condition.textonfailed.text);\n                                                $message.find('.passfail-message').remove();\n                                                $message.find(`#content`)\n                                                    .prepend(`<div class=\"alert bg-secondary mt-2 mx-3 passfail-message\">\n                                                ${textonfailed}</div>`);\n                                                notifyFilter($('.passfail-message'));\n                                            }\n                                        } else {\n                                            if (condition.gotoonpassing == 1 && condition.forceonpassing != 1) {\n                                                onPassFail(true, condition.timeonpassing);\n                                            } else if (condition.gotoonpassing == 1 && condition.forceonpassing == 1) {\n                                                setTimeout(function() {\n                                                    // Trigger close button.\n                                                    $message.find('.interaction-dismiss').trigger('click');\n                                                    self.player.seek(condition.timeonpassing);\n                                                    self.player.play();\n                                                }, 1000);\n                                            }\n                                            if (condition.showtextonpassing == 1 && condition.textonpassing.text != '') {\n                                                let textonpassing = await self.formatContent(condition.textonpassing.text);\n                                                $message.find('.passfail-message').remove();\n                                                $message.find(`#content`)\n                                                    .prepend(`<div class=\"alert bg-secondary mt-2 mx-3 passfail-message\">\n                                                ${textonpassing}</div>`);\n                                                notifyFilter($('.passfail-message'));\n                                            }\n                                        }\n                                    }\n                                }\n                            });\n                        } catch (e) {\n                            requestAnimationFrame(detectH5P);\n                        }\n                    } else {\n                        requestAnimationFrame(detectH5P);\n                    }\n                };\n                requestAnimationFrame(detectH5P);\n            };\n            // We don't need to run the render method every time the content is applied. We can cache the content.\n            let firstview = false;\n            if (!self.cache[annotation.id] || self.isEditMode()) {\n                self.cache[annotation.id] = await self.render(annotation);\n                firstview = true;\n            }\n            const data = self.cache[annotation.id];\n\n            $message.find(`.modal-body`).html(data).attr('id', 'content').fadeIn(300);\n\n            self.postContentRender(annotation, xAPICheck(annotation));\n\n            if (existingstate !== null && existingstate !== undefined) {\n                return;\n            }\n\n            if (self.isEditMode()) {\n                return;\n            }\n\n            // If annotation is incomplete, we want to save the state when the interaction is closed.\n            $(document).on('interactionclose interactionrefresh', async function(e) {\n                if (!annotation.completed && firstview && saveState == 1) {\n                    if (e.detail.annotation.id == annotation.id) {\n                        try {\n                            let content = window.H5PIntegration.contents;\n                            let id = Object.keys(content)[0];\n                            let contentuserData = window.H5PIntegration.contents[id].contentUserData[0];\n                            let state = contentuserData.state;\n                            await self.saveLog(annotation, {\n                                text1: JSON.stringify(state),\n                                char1: annotation.type,\n                            }, self.userid, true);\n                        } catch (e) {\n                            window.console.log('Error: ', e);\n                        }\n                    }\n                }\n                // Remove window.\n            });\n\n            if (annotation.hascompletion != 1) {\n                return;\n            }\n            if (!annotation.completed && annotation.completiontracking == 'view') {\n                self.completiononview(annotation);\n            }\n        };\n\n        if (existingstate !== null && existingstate !== undefined) { // Report view.\n            afterLog(existingstate);\n            return;\n        }\n\n        // Get exiting state.\n        if (self.isEditMode()) {\n            afterLog('');\n            return;\n        }\n        if (saveState !== 1) {\n            afterLog('');\n            return;\n        }\n        let logs = await self.getLogs(annotation, [self.userid]);\n        let log = '';\n        if (logs.length <= 0) {\n            afterLog('');\n            return;\n        }\n        if (logs.length > 0) {\n            log = JSON.parse(logs[0].text1);\n            // Show a confirmation message if the state is not empty.\n            if (log !== '' && log !== null) {\n                Notification.saveCancel(\n                    M.util.get_string('resume', 'ivplugin_contentbank'),\n                    M.util.get_string('resumeconfirm', 'ivplugin_contentbank'),\n                    M.util.get_string('resume', 'ivplugin_contentbank'),\n                    function() {\n                        // Do nothing.\n                        afterLog(log);\n                    },\n                    function() {\n                        log = '';\n                        afterLog(log);\n                    }\n                );\n            } else {\n                afterLog(log);\n            }\n        }\n    }\n\n    async getCompletionData(annotation, userid) {\n        let logs = await this.getLogs(annotation, [userid]);\n        let log = '';\n        if (logs.length > 0) {\n            log = JSON.parse(logs[0].text1);\n        }\n        annotation.displayoptions = 'popup';\n        annotation.hascompletion = 0;\n        annotation.completed = true;\n        await this.renderViewer(annotation);\n        this.renderContainer(annotation);\n        this.applyContent(annotation, log);\n        return log;\n    }\n}"],"names":["H5pUpload","Base","postContentRender","annotation","callback","self","this","$message","id","addClass","customcss","JSON","parse","prop","checkIframe","iframe","document","querySelector","style","background","contentDocument","h5p","removeClass","find","remove","height","firstdiv","margin","char2","link","node","src","split","pop","createElement","head","h5piframecontent","dir","attr","setDir","advanced","htmltag","parentNode","setAttribute","rel","type","href","appendChild","requestAnimationFrame","completiontracking","$completiontoggle","before","isBS5","M","util","get_string","completed","tooltip","setTimeout","hascompletion","onEditFormLoaded","form","event","timepicker","required","existingstate","annoid","onPassFail","async","passed","time","label","append","off","on","e","preventDefault","data","trigger","player","seek","play","saveState","condition","text1","savecurrentstate","afterLog","firstview","cache","isEditMode","render","html","fadeIn","detectH5P","H5P","contentWindow","undefined","externalDispatcher","H5PIntegration","prepend","window","saveFreq","content","contents","Object","keys","log","contentUserData","state","statement","verb","object","indexOf","context","contextActivities","parent","Audio","cfg","wwwroot","complete","textclass","result","score","scaled","details","completeTime","Date","windowAnno","ANNOS","x","xp","char1","toFixed","duration","getTime","newstarttime","timecompleted","completiontime","toLocaleString","formatTime","reportView","raw","max","Number","toggleCompletion","gotoonfailed","forceonfailed","timeonfailed","showtextonfailed","textonfailed","text","formatContent","gotoonpassing","forceonpassing","timeonpassing","showtextonpassing","textonpassing","xAPICheck","detail","saveLog","stringify","userid","console","completiononview","logs","getLogs","length","saveCancel","displayoptions","renderViewer","renderContainer","applyContent"],"mappings":"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"}