define("local_ivh5pupload/main",["exports","jquery","mod_interactivevideo/type/base","core_filters/events"],(function(_exports,_jquery,_base,_events){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Main class for the H5P Upload plugin.
   *
   * @module     local_ivh5pupload/main
   * @copyright  2024 Sokunthearith Makara <sokunthearithmakara@gmail.com>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_jquery=_interopRequireDefault(_jquery),_base=_interopRequireDefault(_base);class H5pUpload extends _base.default{renderContainer(annotation){let $message=(0,_jquery.default)("#message[data-id='".concat(annotation.id,"']"));if(super.renderContainer(annotation),"view"!==annotation.completiontracking){let $completiontoggle=$message.find("#completiontoggle");if($message.find("#title .info").remove(),$completiontoggle.before('<i class="bi bi-info-circle-fill mr-2 info" data-toggle="tooltip"\n            data-container="#wrapper" data-trigger="hover"\n            data-title="'.concat(M.util.get_string("completionon"+annotation.completiontracking,"mod_interactivevideo"),'"></i>')),annotation.completed)return;setTimeout((function(){$message.find('[data-toggle="tooltip"]').tooltip("show")}),1e3),setTimeout((function(){$message.find('[data-toggle="tooltip"]').tooltip("hide")}),3e3)}}postContentRender(annotation,callback){(0,_jquery.default)("#message[data-id='".concat(annotation.id,"']")).addClass("hascontentbank overflow-hidden");let customcss=JSON.parse(annotation.prop).customcss,checkIframe=()=>{const iframe=document.querySelector("#message[data-id='".concat(annotation.id,"'] iframe"));if(iframe){iframe.style.background="none";let contentDocument=iframe.contentDocument,h5p=contentDocument.querySelector(".h5p-initialized");if(h5p){(0,_jquery.default)("#message[data-id='".concat(annotation.id,"']")).removeClass("overflow-hidden").find(".loader").remove(),contentDocument.querySelector("html").style.height="unset";let firstdiv=contentDocument.querySelector("body > div");if(firstdiv&&(firstdiv.style.margin="0"),customcss&&"1"==annotation.char2){let link,node;if("html"==iframe.src.split(".").pop())link=contentDocument.createElement("link"),node=contentDocument.head;else{let h5piframecontent=contentDocument.querySelector("#".concat(h5p.id)).contentDocument;link=h5piframecontent.createElement("link"),node=h5piframecontent.head}link.rel="stylesheet",link.type="text/css",link.href=customcss,node.appendChild(link)}}else requestAnimationFrame(checkIframe)}else requestAnimationFrame(checkIframe)};return requestAnimationFrame(checkIframe),!(1==annotation.hascompletion&&"manual"==annotation.completiontracking&&!annotation.completed&&"view"!=annotation.completiontracking)||callback}onEditFormLoaded(form,event){return this.timepicker({required:!0}),{form:form,event:event}}async applyContent(annotation){const annoid=annotation.id;let self=this,$message=(0,_jquery.default)("#message[data-id='".concat(annoid,"']"));$message.removeClass("modal-dialog-centered");const onPassFail=async(passed,time)=>{let label=passed?"continue":"rewatch";$message.find("#content").append('<button class="btn btn-'.concat(passed?"success":"danger",' mt-2 btn-rounded"\n                    id="passfail" data-timestamp="').concat(time,'"><i class="fa fa-').concat(passed?"play":"redo",' mr-2"></i>\n                ').concat(M.util.get_string(label,"ivplugin_contentbank"),"\n                </button>")),$message.find("iframe").addClass("no-pointer-events")};(0,_jquery.default)(document).off("click","#passfail").on("click","#passfail",(function(e){e.preventDefault();let time=(0,_jquery.default)(this).data("timestamp");self.dispatchEvent("interactionclose",{annotation:annotation}),self.player.seek(time),self.player.play(),(0,_jquery.default)(this).remove()}));self.cache[annotation.id]&&!self.isEditMode()||(self.cache[annotation.id]=await this.render(annotation,"html"));let data=self.cache[annotation.id];(0,_jquery.default)("#message[data-id='".concat(annotation.id,"'] .modal-body")).attr("id","content").html(data).fadeIn(300),0!=annotation.hascompletion&&(annotation.completed||"view"!=annotation.completiontracking?annotation.completed?this.postContentRender(annotation):this.postContentRender(annotation,(annotation=>{let H5P;const detectAPI=()=>{try{H5P=document.querySelector("#message[data-id='".concat(annoid,"'] iframe")).contentWindow.H5P}catch(e){H5P=null}if(null!=H5P){self.isEditMode()&&((0,_jquery.default)("#message[data-id='".concat(annotation.id,"'] #title .xapi")).remove(),(0,_jquery.default)("#message[data-id='".concat(annotation.id,"'] #title .btns")).prepend('<div class="xapi alert-secondary d-inline px-2 rounded-pill">\n                            '.concat(M.util.get_string("xapicheck","local_ivh5pupload"),"</div>")));let statements=[];try{H5P.externalDispatcher.on("xAPI",(async function(event){if("http://adlnet.gov/expapi/verbs/completed"!=event.data.statement.verb.id&&"http://adlnet.gov/expapi/verbs/answered"!=event.data.statement.verb.id||statements.push(event.data.statement),("http://adlnet.gov/expapi/verbs/completed"==event.data.statement.verb.id||"http://adlnet.gov/expapi/verbs/answered"==event.data.statement.verb.id)&&event.data.statement.object.id.indexOf("subContentId")<0){if(self.isEditMode())return(0,_jquery.default)("#message[data-id='".concat(annotation.id,"'] #title .btns .xapi")).remove(),(0,_jquery.default)("#message[data-id='".concat(annotation.id,"'] #title .btns")).prepend('<div class="xapi alert-success d-inline px-2 rounded-pill">\n                                        <i class="fa fa-check mr-2"></i>\n                                        '.concat(M.util.get_string("xapieventdetected","local_ivh5pupload"),"\n                                        </div>")),void new Audio(M.cfg.wwwroot+"/mod/interactivevideo/sounds/pop.mp3").play();let complete=!1,textclass="";if(("completepass"==annotation.completiontracking&&event.data.statement.result&&event.data.statement.result.score.scaled>=.5||"completefull"==annotation.completiontracking&&event.data.statement.result&&1==event.data.statement.result.score.scaled||"complete"==annotation.completiontracking)&&(complete=!0),textclass=event.data.statement.result.score.scaled<.5?"fa fa-check text-danger":event.data.statement.result.score.scaled<1?"fa fa-check text-success":"bi bi-check2-all text-success",complete&&!annotation.completed){let details={};const completeTime=new Date;let windowAnno=window.ANNOS.find((x=>x.id==annotation.id));details.xp=annotation.xp,"1"==annotation.char1&&(details.xp=(event.data.statement.result.score.scaled*annotation.xp).toFixed(2)),details.duration=windowAnno.duration+(completeTime.getTime()-windowAnno.newstarttime),details.timecompleted=completeTime.getTime();const completiontime=completeTime.toLocaleString();let duration=self.formatTime(details.duration/1e3);details.reportView='<span data-toggle="tooltip" data-html="true"\n                     data-title=\'<span class="d-flex flex-column align-items-start"><span><i class="bi bi-calendar mr-2"></i>\n                     '.concat(completiontime,'</span><span><i class="bi bi-stopwatch mr-2"></i>').concat(duration,'</span>\n                     <span><i class="bi bi-list-check mr-2"></i>\n                     ').concat(event.data.statement.result.score.raw,"/").concat(event.data.statement.result.score.max,"</span></span>'>\n                     <i class=\"").concat(textclass,'"></i><br><span>').concat(Number(details.xp),"</span></span>"),details.details=statements,self.toggleCompletion(annoid,"mark-done","automatic",details)}if(""!=annotation.text1){let condition=JSON.parse(annotation.text1);if(event.data.statement.result.score.scaled<.5){if(1==condition.gotoonfailed&&1!=condition.forceonfailed?onPassFail(!1,condition.timeonfailed):1==condition.gotoonfailed&&1==condition.forceonfailed&&setTimeout((function(){self.dispatchEvent("interactionclose",{annotation:annotation}),self.player.seek(condition.timeonfailed),self.player.play()}),1e3),1==condition.showtextonfailed&&""!=condition.textonfailed.text){let textonfailed=await self.formatContent(condition.textonfailed.text);$message.find(".passfail-message").remove(),$message.find("#content").prepend('<div class="alert bg-secondary mt-2 mx-3 passfail-message">\n                                                                            '.concat(textonfailed,"</div>")),(0,_events.notifyFilterContentUpdated)((0,_jquery.default)(".passfail-message"))}}else if(1==condition.gotoonpassing&&1!=condition.forceonpassing?onPassFail(!0,condition.timeonpassing):1==condition.gotoonpassing&&1==condition.forceonpassing&&setTimeout((function(){self.dispatchEvent("interactionclose",{annotation:annotation}),self.player.seek(condition.timeonpassing),self.player.play()}),1e3),1==condition.showtextonpassing&&""!=condition.textonpassing.text){let textonpassing=await self.formatContent(condition.textonpassing.text);$message.find(".passfail-message").remove(),$message.find("#content").prepend('<div class="alert bg-secondary mt-2 mx-3 passfail-message">\n                                                                            '.concat(textonpassing,"</div>")),(0,_events.notifyFilterContentUpdated)((0,_jquery.default)(".passfail-message"))}}}}))}catch(e){requestAnimationFrame(detectAPI)}}else requestAnimationFrame(detectAPI)};requestAnimationFrame(detectAPI)})(annotation)):self.completiononview(annotation))}}return _exports.default=H5pUpload,_exports.default}));

//# sourceMappingURL=main.min.js.map